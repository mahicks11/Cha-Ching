var chaChing={};chaChing.Error=function(){var config=function(debugEnabled,errorCode,errorMessage){this.debugEnabled=debugEnabled!=="undefined"?debugEnabled:false,this.errorCode=errorCode,this.errorMessage=errorMessage};var log=function(){if(this.debugEnabled)console.log(this.errorCode+" - "+this.errorMessage)};return{log:log,config:config}};var chaChing=chaChing||{};
chaChing.Evaluator=function(){var config=function(data,expression){this.data=data,this.expression=expression};var getMatchingObjects=function(data,expression){if(!data)return[];if(expression.indexOf("!=")>=0||expression.indexOf("==")>=0||expression.indexOf("<")>=0||expression.indexOf(">")>=0||expression.indexOf(">=")>=0||expression.indexOf("<=")>=0)return dataMatchingCondition(data,expression)};function xor(a,b){return a&&!b||b&&!a}var dataMatchingCondition=function(data,expression){console.log("Matching Conditions");
console.log("data");console.log(data);console.log("condiiton: "+expression);var matchingElements=[];var notequals=expression.indexOf("!=")>=0;var EQUALS_REGEX=/[a-zA-Z0-9\s\w_]+==[a-zA-Z0-9\s\w_]+/g;var COMPARE_REGEX=/[a-zA-Z0-9\s\w_]+[><]+[=]?[a-zA-Z0-9\s\w_]+/g;var localexpression=expression.replace("!==","==").replace("!=","==");console.log("local expression: "+localexpression);if(Array.isArray(data))data.forEach(function(nestedObject,index){if(Array.isArray(nestedObject))nestedObject.forEach(function(object,
index){if(localexpression.match(EQUALS_REGEX))localexpression.match(EQUALS_REGEX).forEach(function(predicate,index){var key=predicate.split("==")[0].trim();var value=predicate.split("==")[1].trim();if(typeof object[key]!=="undefined"&&xor(object[key].toString()==value,notequals))matchingElements.push(object)});else if(localexpression.match(COMPARE_REGEX))localexpression.match(COMPARE_REGEX).forEach(function(predicate,index){var COMPARE_EXPRESSION=/[<>=]+/g;var operator=predicate.match(COMPARE_EXPRESSION);
var key=predicate.split(operator)[0].trim();var value=predicate.split(operator)[1].trim();if(operator==">"){if(typeof object[key]!=="undefined"&&object[key]>parseFloat(value)){console.log(object);matchingElements.push(object)}}else if(operator=="<"){if(typeof object[key]!=="undefined"&&object[key]<parseFloat(value)){console.log(object);matchingElements.push(object)}}else if(operator==">="){if(typeof object[key]!=="undefined"&&object[key]>=parseFloat(value)){console.log(object);matchingElements.push(object)}}else if(operator==
"<="){console.log("greather than");if(typeof object[key]!=="undefined"&&object[key]<=parseFloat(value)){console.log(object);matchingElements.push(object)}}})});else if(localexpression.match(EQUALS_REGEX))localexpression.match(EQUALS_REGEX).forEach(function(predicate,index){var key=predicate.split("==")[0].trim();var value=predicate.split("==")[1].trim();if(typeof nestedObject[key]!=="undefined"&&xor(nestedObject[key].toString()==value,notequals))matchingElements.push(nestedObject)});else if(localexpression.match(COMPARE_REGEX))localexpression.match(COMPARE_REGEX).forEach(function(predicate,
index){var COMPARE_EXPRESSION=/[<>=]+/g;var operator=predicate.match(COMPARE_EXPRESSION);var key=predicate.split(operator)[0].trim();var value=predicate.split(operator)[1].trim();if(operator==">"){if(typeof nestedObject[key]!=="undefined"&&nestedObject[key]>parseFloat(value)){console.log(nestedObject);matchingElements.push(nestedObject)}}else if(operator=="<"){if(typeof nestedObject[key]!=="undefined"&&nestedObject[key]<parseFloat(value)){console.log(nestedObject);matchingElements.push(nestedObject)}}else if(operator==
">="){if(typeof nestedObject[key]!=="undefined"&&nestedObject[key]>=parseFloat(value)){console.log(nestedObject);matchingElements.push(nestedObject)}}else if(operator=="<="){console.log("greather than");if(typeof nestedObject[key]!=="undefined"&&nestedObject[key]<=parseFloat(value)){console.log(nestedObject);matchingElements.push(nestedObject)}}})});else if(expression.match(EQUALS_REGEX))expression.match(EQUALS_REGEX).forEach(function(predicate,index){var key=predicate.split("==")[0].trim();var value=
predicate.split("==")[1].trim();if(data[key].toString()===value)matchingElements.push(data)});else if(expression.match(COMPARE_REGEX))expression.match(COMPARE_REGEX).forEach(function(predicate,index){var COMPARE_EXPRESSION=/[<>=]+/g;var operator=predicate.match(COMPARE_EXPRESSION);var key=predicate.split(operator)[0].trim();var value=predicate.split(operator)[1].trim();if(operator==">"){if(typeof data[key]!=="undefined"&&data[key]>parseFloat(value)){console.log(data);matchingElements.push(data)}}else if(operator==
"<"){if(typeof data[key]!=="undefined"&&data[key]<parseFloat(value)){console.log(data);matchingElements.push(data)}}else if(operator==">="){if(typeof data[key]!=="undefined"&&data[key]>=parseFloat(value)){console.log(data);matchingElements.push(data)}}else if(operator=="<="){console.log("greather than");if(typeof data[key]!=="undefined"&&data[key]<=parseFloat(value)){console.log(data);matchingElements.push(data)}}});return matchingElements};return{getMatchingObjects:getMatchingObjects,dataMatchingCondition:dataMatchingCondition}};chaChing.Getter=function(){var config=function(config,url){this.config=config,this.url=url};var getData=function(config){console.log("getting data");if(config.dataSrc.indexOf("http")!==-1){console.log("EXTERNAL URL");return getDataFromURL(config,true)}else if(config.dataSrc.indexOf("http")===-1&&config.dataSrc.indexOf("/")!==-1){console.log("INTERNAL URL");return getDataFromURL(config,false)}else return config.dataSrc};var getDataFromURL=function(config,withCredentials){console.log("getting data From URL");
var ajaxRequest=new XMLHttpRequest;ajaxRequest.onreadystatechange=function(){if(this.readyState==4&&this.status==200){config.data=JSON.parse(this.responseText);chaChing.Parser.parseTemplate(config)}else if(this.readyState==4&&(this.status<200||this.status>200))console.log("Status: "+this.status+"-"+this.responseText)};ajaxRequest.withCredentials=withCredentials;ajaxRequest.open("GET",config.dataSrc,true);ajaxRequest.send()};return{getData:getData,getDataFromURL:getDataFromURL}};chaChing.Parser=function(){var config=function(templateConfig){this.templateConfig=templateConfig};var parseTemplate=function parseTemplate(config){console.log("Parsing Custom HTML");var customHTML;var variableRegex=/\${(.*?)}(?![^]*(\[\/\]))/g;var conditionalLoopRegex=/(\$\[(.*)\]([^]+?)\$\[\/\])/g;if(conditionalLoopRegex.test(config.html)){console.log("Contains conditional loop regex");customHTML=parseConditionalLoopElement(config.data,config.html)}if(variableRegex.test(config.html)){console.log("contains variable ");
customHTML=parseVariableElement(config.data,config.html)}config.parsedHTML=customHTML;var element=document.querySelector("#chaching-"+config.cache);element.outerHTML=config.parsedHTML};function parseConditionalLoopElement(templateData,customHtml,isNested){console.log("parsing conditional element");var nestedLoopRegex=/(\$\[([\w\.]*\s*:*\s*\w*\s*[!=]*\s*\w+[||*\s*\w*\s*[!==><]*\s*\w+]*)\]([^]+?)\[\/\])/g;var outerLoopRegex=/(\$\[([\w\.]*\s*:*\s*\w*\s*[!=]*\s*\w+[||*\s*\w*\s*[!==><]*\s*\w+]*)\]([^]+?)\$\[\/\])/g;
var variableRegex=/\${(.*?)}(?![^]*(SAS\.DataTable|\[\/\]))/g;var conditionalLoopRegex=!isNested?outerLoopRegex:nestedLoopRegex;var matches;var count=0;while(matches=conditionalLoopRegex.exec(customHtml)){var replacementString="";var conditionalLoopElement=matches[1].trim();var conditionalLoopClause=matches[2].trim();var content=matches[3].trim();var objectPath=null;var condition=null;var hasCondition=true;if(conditionalLoopClause.split(":").length>1){objectPath=conditionalLoopClause.split(":")[0].trim();
condition=conditionalLoopClause.split(":")[1]}else if(conditionalLoopClause.indexOf("!=")>=0||conditionalLoopClause.indexOf("==")>=0||conditionalLoopClause.indexOf("<")>=0||conditionalLoopClause.indexOf(">")>=0||conditionalLoopClause.indexOf(">=")>=0||conditionalLoopClause.indexOf("<=")>=0){objectPath="";condition=conditionalLoopClause}else{objectPath=conditionalLoopClause;condition=""}if(!condition){console.log("No Condition provided in loop");hasCondition=false}var startingObject=getStartingObject(templateData,
objectPath);var matchingObjects=null;if(hasCondition)matchingObjects=chaChing.Evaluator.getMatchingObjects(startingObject,condition);else matchingObjects=chaChing.Util.getAllObjects(startingObject);if(matchingObjects.length<=0)customHtml=customHtml.replace(conditionalLoopElement,"");else{variableRegex=/\${(.*?)}/g;var containsVariables=variableRegex.test(content);matchingObjects.forEach(function(obj){var parsingContent=content;nestedLoopRegex=/(\$\[([\w\.]*\s*:*\s*\w*\s*[!=]*\s*\w+[||*\s*\w*\s*[!=]*\s*\w+]*)\]([^]+?)\[\/\])/g;
if(nestedLoopRegex.test(parsingContent))parsingContent=parseConditionalLoopElement(obj,parsingContent,true);if(containsVariables)replacementString+=parseVariableElement(obj,parsingContent);else replacementString+=parsingContent});customHtml=customHtml.replace(conditionalLoopElement,replacementString)}matches=0}return customHtml}function parseVariableElement(templateData,customHtml){console.log("parsing variable element");if(typeof templateData=="undefined"||!templateData){console.log("data undefined");
return customHtml}var replacementString="";var sortString="";var variableRegex=/\${(.*?)}(?![^]*(SAS\.DataTable|\[\/\]))/g;customHtml.match(variableRegex).forEach(function(variable,index){console.log("variable: "+variable);console.log("index"+index);console.log("template data: "+templateData);var propertyArray=variable.split(/\|/);var property=variable.indexOf("|")>=0?propertyArray[0].replace("{","").replace(/\$/g,""):variable.replace("{","").replace(/\$/g,"").replace("}","");var defaultValue=variable.indexOf("|")>=
0?propertyArray[1].replace("}",""):"";var dateTimeFormat=propertyArray.length>2?propertyArray[2].replace("}",""):"";var propertyValue="null";if(property=="this"&&typeof templateData==="string"){console.log("property value");propertyValue=templateData}else if(property.indexOf(".")>=0){console.log("Property: "+property);var obj=SAS.Utils.getObject(templateData,property);if(typeof obj==="number")obj=JSON.stringify(obj);propertyValue=obj}else{console.log("default");propertyValue=templateData[property];
if(typeof propertyValue==="undefined"&&typeof templateData[0]==="object"&&templateData[0]!==null)propertyValue=templateData[0][property];console.log("property value: "+propertyValue)}sortString=propertyValue;if(dateTimeFormat.length>0&&typeof propertyValue==="string"){propertyValue=date._isValid?date.format(dateTimeFormat):"";sortString=date.format("YYYYMMDD");templateData[property+"_sort"]=sortString}replacementString=propertyValue?propertyValue:defaultValue;customHtml=customHtml.replace(variable,
replacementString)});console.log("custom HTML: "+customHtml);return customHtml}function initializeData(data,rootPath,condition){if(!condition)return initializeDataAll(data,rootPath);var data=initializeDataAll(data,rootPath);var filteredObject=[];try{var notequals=true;var variable=condition.indexOf("!");if(variable<0){notequals=false;variable=condition.indexOf("=")}var value=condition.substring(variable);variable=condition.substring(0,variable);variable=variable.trim();value=value.replace(/[^a-zA-Z\d_.]+/,
"");data.forEach(function(element){if(value){if(xor(notequals,SAS.Utils.getObject(element,variable)===value))filteredObject.push(element)}else{var rowtest=SAS.Utils.getObject(element,variable);if(rowtest)filteredObject.push(element)}})}catch(err){console.log("error filtering data for condition "+condition);return data}return filteredObject}function initializeDataAll(data,rootPath){var filteredObject=[];if(!rootPath)return data;if(!Array.isArray(data))return SAS.Utils.getObject(data,rootPath);else if(data.length<=
1)return data[0][rootPath];else{data.forEach(function(element){var selectedElement=element[rootPath];if(!selectedElement||!Array.isArray(selectedElement))filteredObject.push(element[rootPath]);else element[rootPath].forEach(function(nestedElement){filteredObject.push(nestedElement)})});return filteredObject}}function getStartingObject(data,rootPath){if(!data)return;var filteredObject=[];if(!rootPath)return data;if(rootPath.indexOf(".")<0){if(Array.isArray(data))data.forEach(function(element){filteredObject.push(element[rootPath])});
else if(typeof data[rootPath]=="undefined"||!data[rootPath]){console.log("starting object is undefined");return}else filteredObject.push(data[rootPath]);return filteredObject}var objectArray=rootPath.split(".");var previousObject=objectArray.shift();var remainingObjects=objectArray.join(".");return getStartingObject(data[previousObject],remainingObjects)}return{config:config,parseTemplate:parseTemplate}};chaChing.Scanner=function(){var generateHashFromTemplate=function(string){var hash=0;if(string.length==0)return hash;for(var i=0;i<string.length;i++){var charCode=string.charCodeAt(i);hash=(hash<<7)-hash+charCode;hash=hash&hash}return hash};var scan=function(){var defaultConfig={debugMode:false,cache:"",rootPath:"",cssClass:"",dataSrc:null,data:{},html:"",parsedHTML:""};var templates=document.querySelectorAll('script[type="chaching-template"]');var templateConfigs=[];templates.forEach(function(template,
index){var config=Object.assign({},defaultConfig);config.debugMode=template.getAttribute("debugMode");config.dataSrc=template.getAttribute("data-src");config.rootPath=template.getAttribute("rootPath");config.html=template.innerHTML;config.cache=generateHashFromTemplate(template.innerHTML);template.setAttribute("id","chaching-"+config.cache);config.data=chaChing.Getter.getData(config);templateConfigs.push(config)});console.log(templateConfigs);return templateConfigs};return{generateHashFromTemplate:generateHashFromTemplate,
scan:scan}};chaChing.Util=function(){var getAllObjects=function(data){if(!data)return[];var allElements=[];if(Array.isArray(data))data.forEach(function(nestedObject,index){if(Array.isArray(nestedObject))nestedObject.forEach(function(object,index){allElements.push(object)})});else allElements.push(data);return allElements};return{getAllObjects:getAllObjects}};chaChing.Writer=function(){var write=function(template){}};chaChing=function(){return{Scanner:chaChing.Scanner(),Getter:chaChing.Getter(),Parser:chaChing.Parser(),Evaluator:chaChing.Evaluator(),Writer:chaChing.Writer(),Util:chaChing.Util(),Error:chaChing.Error()}}();chaChing.Scanner.scan();
